\include{linux-qa-common} 

\qatrainingtitle{8}{Отладка приложений} 

\begin{document}

\firstframe

\begin{frame}{Лимиты для процесса}
  \begin{block}{\alert{ulimit}}
    Встроенная команда Shell, позволяющая контролировать количество ресурсов, выделяемых процессам, запускающимся из Shell.
  \end{block} \pause

  \begin{block}{Что можно контролировать}
    \begin{itemize}
      \item время выполнения (cpu time)
      \item максимальный размер данных (data) и стека (stack)
      \item количество открытых файлов (open files)
      \item максимальный размер core dump (core file)
    \end{itemize}
  \end{block} 
\small
  Примечание: для обычного пользователя работают только в сторону ужесточения, без возможности отката.
  \pause

  \alert{Упражнение 1}: задать лимиты памяти (virtual memory, max memory size), чтобы vim не хватало для запуска

  \alert{Упражнение 2}: задать лимиты времени выполнения

\end{frame}

\begin{frame}{Отладочная информация}
  \label{debug-info}
  \begin{block}{Отладочная информация}
    Программа может быть скомпилирована с отладочной информацией: именами переменных и функций.
  \end{block}

  \begin{block}{Просмотр отладочной информации}
    \begin{itemize}
      \item \alert{nm} отладочные символы
      \item \alert{ldd} список динамических библиотек, используемых данной программой или библиотекой
    \end{itemize}
  \end{block} 

  Часто отладочная информация упаковывается мантейнерами в отдельные пакеты\footnote{Суффиксы -dbg, -debug. Например \alert{libc6-dbg, vim-dbg} }

  \alert{Упражнение 1} Просмотреть отладочную информацию для vim

  \alert{Упражнение 2} Просмотреть список динамических библиотек для vim
\end{frame}

\begin{frame}{Core dump}
  \begin{block}{Core dump file}
    Файл, содержащий образ памяти процесса на момент прерывания выполнения по сигналу\footnote{man 7 signal - список сигналов, вызывающий core dump}
  \end{block} 

  \alert{Упражнение} Установить лимит на размер core больший нуля. Запустить vim в фоне (Shell job). Пристрелить vim с помощью сигнала, вызывающего генерацию core dump. \pause

\end{frame}

\begin{frame}{Отладчик gdb}
  \begin{block}{GDB}
    Позволяет контролировать ход выполнения программы (запуск, остановка, выполнение по шагам) и проверять её состояние. 
  \end{block} 
  Для получения осмысленных данных - требует наличия отладочной информации [\ref{debug-info}] в программе и библиотеках её использующих.  \pause
   
  \begin{block}{Наиболее существенные (для нас) функции}
    \begin{itemize}
      \item установка точек прерывания (\alert{break})
      \item просмотр стека вызовов (\alert{bt} или \alert{backtrace})
      \item запуск приложений c параметрами (\alert{file} и \alert{run})
      \item присоединение к запущенным процессам (\alert{attach})
      \item остановка по сигналам и точкам останова
      \item продолжение выполнения (\alert{cont})
    \end{itemize}
  \end{block}
\end{frame}

\begin{frame}{GDB - практика}

  \alert{Упражнение 1} Загрузить vim вместе с core-дампом из предыдущего упражнения. Получить backtrace.

  \alert{Упражнение 2}. Подсоединиться к своему сессионному shell. С помощью backtrace определить что он делает сейчас.

  \alert{Упражнение 3}. Загрузить ``ls'' в отладчик. Установить точки прерывания на функцию open. Выполнить ``ls -l'' в отладчике. Проанализировать стек вызовов.

\end{frame}

\begin{frame}{Трассировка вызовов функций}
  Трассировка вызовов
  \begin{itemize}
    \item \alert{strace} - системных (ядро)
    \item \alert{ltrace} - библиотечных (внешние библиотеки)
  \end{itemize} \pause

  \alert{Упражнение 1} запустить vim под strace, с сохранением вывода в файл

  \alert{Упражнение 2} запустить vim под ltrace, c сохранением вывода в файл

  \alert{Упражение 3} подсоединить strace к своему текущему shell, в фоне, с сохранением вывода в файл
  
  \alert{Упражение 4} подсоединить ltrace к своему текущему shell, в фоне, с сохранением вывода в файл
\end{frame}

\end{document}
